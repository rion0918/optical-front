# 認証システムテストガイド

## 概要

このドキュメントは、実装した認証システムのマニュアルテスト手順を記載しています。
すべてのテストケースが成功することで、実装が完了したと判断できます。

## 前提条件

1. 開発サーバーが起動していること (`pnpm dev`)
2. ブラウザで http://localhost:3000 にアクセスできること
3. MSW (Mock Service Worker) が有効であること

## テスト用モックユーザー

以下のユーザーがモックデータとして定義されています:

```typescript
// 通常ユーザー
1. john@example.com / password123
2. jane@example.com / password456
3. admin@example.com / adminpass

// 削除済みユーザー (403エラー確認用)
4. deleted@example.com / password123
```

## テストケース

### 1. 未認証ユーザーのリダイレクト ✅

**目的**: 未認証ユーザーが保護されたページにアクセスしようとした際、ランディングページにリダイレクトされることを確認

**手順**:

1. ブラウザのローカルストレージをクリア (`localStorage.clear()` in DevTools Console)
2. `http://localhost:3000` にアクセス
3. `/landing` にリダイレクトされることを確認
4. ランディングページに「ログイン」「新規登録」ボタンが表示されることを確認

**期待結果**:

- ✅ 自動的に `/landing` にリダイレクトされる
- ✅ ランディングページが表示される
- ✅ CTA ボタンが 2 つ表示される

---

### 2. 新規登録フロー (成功) ✅

**目的**: 新しいユーザーが正常にサインアップできることを確認

**手順**:

1. ランディングページから「新規登録」ボタンをクリック
2. `/auth/signup` に遷移することを確認
3. 以下の情報を入力:
   - 名前: `Test User`
   - メール: `test@example.com`
   - パスワード: `password123`
4. 「アカウントを作成」ボタンをクリック

**期待結果**:

- ✅ フォーム送信中、ボタンがローディング状態になる
- ✅ 成功後、`/` (カレンダーページ) にリダイレクトされる
- ✅ 右上にユーザー名 (Test User) とアカウントメニューが表示される
- ✅ トークンが localStorage に保存される (`localStorage.getItem('auth_token')`)

---

### 3. 新規登録フロー (バリデーションエラー) ⚠️

**目的**: クライアント側のバリデーションが正しく動作することを確認

**手順**:

1. `/auth/signup` にアクセス
2. 各フィールドを空のまま「アカウントを作成」ボタンをクリック
3. 次に、無効なメールアドレス (例: `invalid-email`) を入力して送信
4. 次に、短いパスワード (例: `pass`) を入力して送信

**期待結果**:

- ✅ 空フィールド: エラートーストが表示される
- ✅ 無効なメール: エラートーストが表示される
- ✅ 短いパスワード: エラートーストが表示される

---

### 4. 新規登録フロー (重複メールエラー) ⚠️

**目的**: 既に存在するメールアドレスでの登録が拒否されることを確認

**手順**:

1. `/auth/signup` にアクセス
2. 既存ユーザーのメールアドレスを使用:
   - 名前: `Duplicate User`
   - メール: `john@example.com` (既存)
   - パスワード: `password123`
3. 「アカウントを作成」ボタンをクリック

**期待結果**:

- ✅ HTTP 400 エラーのトーストが表示される
- ✅ メッセージ: "400: このメールアドレスは既に登録されています"
- ✅ サインアップページに留まる

---

### 5. ログインフロー (成功) ✅

**目的**: 既存ユーザーが正常にログインできることを確認

**手順**:

1. ログアウト状態にする (localStorage.clear() または Logout ボタン)
2. ランディングページから「ログイン」ボタンをクリック
3. `/auth/login` に遷移することを確認
4. 既存ユーザーの認証情報を入力:
   - メール: `john@example.com`
   - パスワード: `password123`
5. 「ログイン」ボタンをクリック

**期待結果**:

- ✅ フォーム送信中、ボタンがローディング状態になる
- ✅ 成功後、`/` (カレンダーページ) にリダイレクトされる
- ✅ 右上にユーザー名 (John Doe) とアカウントメニューが表示される
- ✅ トークンが localStorage に保存される

---

### 6. ログインフロー (認証エラー) ⚠️

**目的**: 無効な認証情報でのログインが拒否されることを確認

**テストケース A: 存在しないユーザー**

1. `/auth/login` にアクセス
2. 存在しないメールアドレスを入力:
   - メール: `nonexistent@example.com`
   - パスワード: `anypassword`
3. 「ログイン」ボタンをクリック

**期待結果**:

- ✅ HTTP 401 エラーのトーストが表示される
- ✅ メッセージ: "401: メールアドレスまたはパスワードが正しくありません"

**テストケース B: 間違ったパスワード**

1. `/auth/login` にアクセス
2. 正しいメールだが間違ったパスワードを入力:
   - メール: `john@example.com`
   - パスワード: `wrongpassword`
3. 「ログイン」ボタンをクリック

**期待結果**:

- ✅ HTTP 401 エラーのトーストが表示される
- ✅ メッセージ: "401: メールアドレスまたはパスワードが正しくありません"

---

### 7. ログインフロー (削除済みユーザー) ⚠️

**目的**: 削除されたユーザーがログインできないことを確認

**手順**:

1. `/auth/login` にアクセス
2. 削除済みユーザーの認証情報を入力:
   - メール: `deleted@example.com`
   - パスワード: `password123`
3. 「ログイン」ボタンをクリック

**期待結果**:

- ✅ HTTP 403 エラーのトーストが表示される
- ✅ メッセージ: "403: このアカウントは削除されています"
- ✅ ログインページに留まる

---

### 8. Google OAuth フロー (モック) ✅

**目的**: Google 認証ボタンが正しく動作することを確認

**手順**:

1. `/auth/login` または `/auth/signup` にアクセス
2. 「Google でログイン」ボタンをクリック
3. MSW がモックレスポンスを返すことを確認

**期待結果**:

- ✅ `/api/auth/google` にリダイレクトされる
- ✅ MSW が `/api/auth/google/callback?token=...` にリダイレクトする
- ✅ コールバックページがトークンを処理し、カレンダーページにリダイレクトする
- ✅ ログイン状態になる

**注意**: 実際の Google OAuth は未実装のため、MSW のモックフローのみテスト可能

---

### 9. ログアウトフロー ✅

**目的**: ユーザーが正常にログアウトできることを確認

**手順**:

1. ログイン状態で `/` (カレンダーページ) にアクセス
2. 右上のアカウントメニューを開く
3. 「Logout」をクリック

**期待結果**:

- ✅ トークンが localStorage から削除される
- ✅ `/landing` にリダイレクトされる
- ✅ アカウントメニューが表示されない
- ✅ 「ログイン」「新規登録」ボタンが表示される

---

### 10. 保護されたルート (認証済み) ✅

**目的**: 認証済みユーザーがカレンダーページにアクセスできることを確認

**手順**:

1. 上記の手順でログイン
2. ブラウザのアドレスバーに `http://localhost:3000` を直接入力してアクセス

**期待結果**:

- ✅ カレンダーページが表示される
- ✅ リダイレクトされない
- ✅ ユーザー情報が表示される

---

### 11. 保護されたルート (未認証) ✅

**目的**: 未認証ユーザーがカレンダーページにアクセスできないことを確認

**手順**:

1. ログアウト (または localStorage.clear())
2. ブラウザのアドレスバーに `http://localhost:3000` を直接入力してアクセス

**期待結果**:

- ✅ `/landing` にリダイレクトされる
- ✅ カレンダーページは表示されない

---

### 12. 既にログイン済みの場合のリダイレクト ✅

**目的**: ログイン済みユーザーが認証ページにアクセスした際、カレンダーページにリダイレクトされることを確認

**手順**:

1. ログイン状態で以下の URL に直接アクセス:
   - `http://localhost:3000/auth/login`
   - `http://localhost:3000/auth/signup`

**期待結果**:

- ✅ どちらも `/` (カレンダーページ) にリダイレクトされる
- ✅ ログイン/サインアップフォームは表示されない

---

### 13. トークン有効期限の確認 ⏰

**目的**: トークンの有効期限が切れた場合、再認証が必要になることを確認

**手順**:

1. ログイン
2. DevTools Console で以下を実行して期限切れトークンをセット:
   ```javascript
   localStorage.setItem(
     "auth_token",
     "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLTEiLCJleHAiOjEwMDAwMDAwMDB9.invalid"
   );
   ```
3. ページをリロード

**期待結果**:

- ✅ トークンが無効なため、`/landing` にリダイレクトされる
- ✅ ログアウト状態になる

---

## テスト完了チェックリスト

すべてのテストケースで期待結果が得られたらチェックを付けてください:

- [ ] 1. 未認証ユーザーのリダイレクト
- [ ] 2. 新規登録フロー (成功)
- [ ] 3. 新規登録フロー (バリデーションエラー)
- [ ] 4. 新規登録フロー (重複メールエラー)
- [ ] 5. ログインフロー (成功)
- [ ] 6. ログインフロー (認証エラー)
- [ ] 7. ログインフロー (削除済みユーザー)
- [ ] 8. Google OAuth フロー (モック)
- [ ] 9. ログアウトフロー
- [ ] 10. 保護されたルート (認証済み)
- [ ] 11. 保護されたルート (未認証)
- [ ] 12. 既にログイン済みの場合のリダイレクト
- [ ] 13. トークン有効期限の確認

## トラブルシューティング

### MSW が動作しない場合

1. ブラウザのコンソールで以下を確認:
   ```
   [MSW] Mocking enabled.
   ```
2. `public/mockServiceWorker.js` が存在することを確認
3. 必要に応じて `pnpm exec msw init public/` を実行

### リダイレクトが動作しない場合

1. ブラウザのキャッシュをクリア
2. localStorage を手動でクリア (`localStorage.clear()`)
3. 開発サーバーを再起動

### トーストが表示されない場合

1. `src/app/layout.tsx` に `<Toaster />` が含まれていることを確認
2. `sonner` パッケージがインストールされていることを確認 (`pnpm list sonner`)

## 次のステップ

すべてのテストが完了したら:

1. ✅ `openspec/changes/add-authentication-system/tasks.md` の Phase 7 を完了としてマーク
2. ✅ 実装の完了を確認
3. ✅ プルリクエストを作成
